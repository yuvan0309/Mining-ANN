<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factor of Safety Prediction System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            padding: 30px;
        }

        .model-selector {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .model-selector h3 {
            margin-bottom: 15px;
        }

        .model-selector select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .input-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .prediction-value {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .status-badge {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin: 15px 0;
        }

        .status-safe {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õèÔ∏è Factor of Safety Prediction</h1>
            <p>Machine Learning-Based Mining Slope Stability Analysis</p>
        </div>

        <div class="main-content">
            <div class="model-selector">
                <h3>üéØ Select Prediction Model</h3>
                <select id="modelSelect">
                    <option value="svm">SVM - R¬≤: 0.9498 (ü•á BEST)</option>
                    <option value="random_forest">Random Forest - R¬≤: 0.9341</option>
                    <option value="xgboost">XGBoost - R¬≤: 0.9204</option>
                    <option value="lightgbm">LightGBM - R¬≤: 0.9192</option>
                    <option value="ann_mlp">ANN - R¬≤: -0.7275 (‚ö†Ô∏è Poor)</option>
                </select>
            </div>

            <form id="predictionForm">
                <div class="input-grid" id="inputGrid">
                    <!-- Inputs will be generated by JavaScript -->
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üéØ Predict FoS</button>
                    <button type="button" class="btn btn-secondary" onclick="loadSample()">üìã Load Sample</button>
                    <button type="reset" class="btn btn-secondary">üîÑ Reset</button>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Calculating...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="results" id="results" style="display: none;">
                <h3>üìä Prediction Results</h3>
                
                <!-- Gauge Visualization -->
                <div style="position: relative; width: 100%; max-width: 400px; margin: 20px auto;">
                    <svg viewBox="0 0 200 120" style="width: 100%; height: auto;">
                        <!-- Background arc segments -->
                        <path d="M 20 100 A 80 80 0 0 1 60 30" fill="none" stroke="#e74c3c" stroke-width="15" opacity="0.3"/>
                        <path d="M 60 30 A 80 80 0 0 1 100 20" fill="none" stroke="#f39c12" stroke-width="15" opacity="0.3"/>
                        <path d="M 100 20 A 80 80 0 0 1 180 100" fill="none" stroke="#2ecc71" stroke-width="15" opacity="0.3"/>
                        
                        <!-- Active segment -->
                        <path id="gaugeActive" d="" fill="none" stroke="#667eea" stroke-width="15"/>
                        
                        <!-- Needle -->
                        <line id="gaugeNeedle" x1="100" y1="100" x2="100" y2="30" stroke="#2c3e50" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="100" cy="100" r="5" fill="#2c3e50"/>
                        
                        <!-- Scale markers -->
                        <text x="20" y="110" font-size="10" fill="#666" text-anchor="middle">0</text>
                        <text x="60" y="25" font-size="10" fill="#666" text-anchor="middle">1.0</text>
                        <text x="100" y="15" font-size="10" fill="#666" text-anchor="middle">1.5</text>
                        <text x="140" y="25" font-size="10" fill="#666" text-anchor="middle">2.0</text>
                        <text x="180" y="110" font-size="10" fill="#666" text-anchor="middle">3.0</text>
                    </svg>
                    
                    <!-- Center value display -->
                    <div style="position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div class="prediction-value" id="predictionValue" style="font-size: 2.5em; font-weight: bold; color: #2c3e50; margin: 0;">-</div>
                    </div>
                </div>
                
                <div class="status-badge" id="statusBadge">Ready</div>
                <p style="text-align: center; margin-top: 15px;">
                    <strong>Model:</strong> <span id="modelUsed">-</span><br>
                    <strong>R¬≤:</strong> <span id="r2">-</span> | 
                    <strong>RMSE:</strong> <span id="rmse">-</span> | 
                    <strong>MAE:</strong> <span id="mae">-</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Material types and their properties
        const materials = [
            'laterite', 'phyllitic_clay', 'lumpy_iron_ore', 'limonitic_clay',
            'manganiferous_clay', 'siliceous_clay', 'bhq', 'schist', 'mean'
        ];

        const properties = ['cohesion_kpa', 'friction_angle_deg', 'unit_weight_kn_per_m3'];

        // Generate input fields
        const inputGrid = document.getElementById('inputGrid');
        materials.forEach(material => {
            properties.forEach(prop => {
                const fieldName = `${material}_${prop}`;
                const label = `${material.replace(/_/g, ' ')} ${prop.replace(/_/g, ' ')}`.replace(/\b\w/g, l => l.toUpperCase());
                
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <label for="${fieldName}">${label}</label>
                    <input type="number" id="${fieldName}" name="${fieldName}" step="0.01" value="0">
                `;
                inputGrid.appendChild(div);
            });
        });

        // Handle form submission
        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const features = {};
            
            for (let [key, value] of formData.entries()) {
                features[key] = parseFloat(value) || 0;
            }
            
            const selectedModel = document.getElementById('modelSelect').value;
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        features: features
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (data.success) {
                    // Display results
                    const fos = data.prediction;
                    document.getElementById('predictionValue').textContent = fos.toFixed(4);
                    document.getElementById('modelUsed').textContent = data.model_used;
                    document.getElementById('r2').textContent = data.model_r2.toFixed(4);
                    document.getElementById('rmse').textContent = data.model_rmse.toFixed(4);
                    document.getElementById('mae').textContent = data.model_mae.toFixed(4);
                    
                    // Update gauge
                    updateGauge(fos);
                    
                    // Set status
                    const statusBadge = document.getElementById('statusBadge');
                    
                    if (fos > 1.5) {
                        statusBadge.className = 'status-badge status-safe';
                        statusBadge.textContent = '‚úÖ SAFE - Excellent stability';
                    } else if (fos >= 1.2) {
                        statusBadge.className = 'status-badge status-warning';
                        statusBadge.textContent = '‚ö†Ô∏è WARNING - Monitor closely';
                    } else {
                        statusBadge.className = 'status-badge status-critical';
                        statusBadge.textContent = 'üö® CRITICAL - Immediate action required';
                    }
                    
                    document.getElementById('results').style.display = 'block';
                } else {
                    document.getElementById('error').textContent = 'Error: ' + data.error;
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
        });

        function loadSample() {
            // Sample data
            const sampleData = {
                'laterite_cohesion_kpa': 35.5,
                'laterite_friction_angle_deg': 28.3,
                'laterite_unit_weight_kn_per_m3': 19.5,
                'phyllitic_clay_cohesion_kpa': 26.5,
                'phyllitic_clay_friction_angle_deg': 24.0,
                'phyllitic_clay_unit_weight_kn_per_m3': 17.2,
                'lumpy_iron_ore_cohesion_kpa': 39.0,
                'lumpy_iron_ore_friction_angle_deg': 37.5,
                'lumpy_iron_ore_unit_weight_kn_per_m3': 21.5,
                'limonitic_clay_cohesion_kpa': 28.5,
                'limonitic_clay_friction_angle_deg': 27.8,
                'limonitic_clay_unit_weight_kn_per_m3': 17.5,
                'manganiferous_clay_cohesion_kpa': 36.0,
                'manganiferous_clay_friction_angle_deg': 28.5,
                'manganiferous_clay_unit_weight_kn_per_m3': 15.0,
                'siliceous_clay_cohesion_kpa': 31.0,
                'siliceous_clay_friction_angle_deg': 27.0,
                'siliceous_clay_unit_weight_kn_per_m3': 16.3,
                'bhq_cohesion_kpa': 45.0,
                'bhq_friction_angle_deg': 38.0,
                'bhq_unit_weight_kn_per_m3': 26.5,
                'schist_cohesion_kpa': 26.5,
                'schist_friction_angle_deg': 30.5,
                'schist_unit_weight_kn_per_m3': 22.5,
                'mean_cohesion_kpa': 33.5,
                'mean_friction_angle_deg': 30.2,
                'mean_unit_weight_kn_per_m3': 19.5
            };
            
            for (let [key, value] of Object.entries(sampleData)) {
                const input = document.getElementById(key);
                if (input) {
                    input.value = value.toFixed(2);
                }
            }
            
            alert('Sample data loaded! Click "Predict FoS" to see the prediction.');
        }

        function updateGauge(fos) {
            // Clamp FoS to 0-3 range
            const clampedFos = Math.max(0, Math.min(3, fos));
            
            // Calculate needle angle (-90¬∞ to 90¬∞)
            const angle = -90 + (clampedFos / 3) * 180;
            const radians = (angle * Math.PI) / 180;
            
            // Calculate needle endpoint
            const centerX = 100;
            const centerY = 100;
            const needleLength = 70;
            const endX = centerX + needleLength * Math.cos(radians);
            const endY = centerY + needleLength * Math.sin(radians);
            
            // Update needle
            const needle = document.getElementById('gaugeNeedle');
            needle.setAttribute('x2', endX);
            needle.setAttribute('y2', endY);
            
            // Determine color and segment
            let color, startAngle, endAngle;
            
            if (fos < 1.0) {
                color = '#e74c3c';
                startAngle = -90;
                endAngle = -90 + (Math.min(fos, 1.0) / 3) * 180;
            } else if (fos < 1.5) {
                color = '#f39c12';
                startAngle = -90 + (1.0 / 3) * 180;
                endAngle = -90 + (Math.min(fos, 1.5) / 3) * 180;
            } else {
                color = '#2ecc71';
                startAngle = -90 + (1.5 / 3) * 180;
                endAngle = -90 + (Math.min(fos, 3.0) / 3) * 180;
            }
            
            // Create arc path
            const radius = 80;
            const startRad = (startAngle * Math.PI) / 180;
            const endRad = (endAngle * Math.PI) / 180;
            
            const x1 = centerX + radius * Math.cos(startRad);
            const y1 = centerY + radius * Math.sin(startRad);
            const x2 = centerX + radius * Math.cos(endRad);
            const y2 = centerY + radius * Math.sin(endRad);
            
            const largeArcFlag = (endAngle - startAngle) > 180 ? 1 : 0;
            const pathData = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`;
            
            // Update active segment
            const activeSegment = document.getElementById('gaugeActive');
            activeSegment.setAttribute('d', pathData);
            activeSegment.setAttribute('stroke', color);
            needle.setAttribute('stroke', color);
        }
    </script>
</body>
</html>
